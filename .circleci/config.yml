version: 2
jobs:
  build_main_deb:
    docker:
      - image: foundationdb/foundationdb-build:latest

    steps:
      - run:
          name: update git version
          command: |
            yum install -y http://opensource.wandisco.com/centos/6/git/x86_64/wandisco-git-release-6-1.noarch.rpm
            yum install -y git
      - checkout
      - run:
          name: get foundationdb sources
          command: |
            git clone https://github.com/apple/foundationdb.git src/__this_is_some_very_long_name_dir_needed_to_fix_a_bug_with_debug_rpms__/foundationdb
            git -C src/__this_is_some_very_long_name_dir_needed_to_fix_a_bug_with_debug_rpms__/foundationdb checkout tags/6.1.11
            echo $(grep -c ^processor /proc/cpuinfo)

      - run:
          name: configure
          command: scl enable devtoolset-8 python27 rh-python36 rh-ruby24 -- bash -c 'cmake -DINSTALL_LAYOUT=DEB src/__this_is_some_very_long_name_dir_needed_to_fix_a_bug_with_debug_rpms__/foundationdb'

      - run:
          name: compile
          command: scl enable devtoolset-8 python27 rh-python36 rh-ruby24 -- bash -c 'make'

      - run:
          name: make packages
          command: scl enable devtoolset-8 python27 rh-python36 rh-ruby24 -- bash -c 'cpack'

workflows:
  version: 2
  build:
    jobs:
      - build_main_deb
